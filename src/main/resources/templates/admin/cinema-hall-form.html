<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - CinemaBooking Admin'">Thêm Phòng Chiếu - CinemaBooking Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Cinema Theme CSS -->
    <link th:href="@{/css/cinema-theme.css}" rel="stylesheet">
    <!-- Admin CSS -->
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body class="bg-dark text-light">
    <!-- Navigation -->
    <nav th:replace="~{layout/fragments/navigation :: nav}"></nav>

    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="text-primary mb-0">
                            <i class="fas fa-couch me-2"></i><span th:text="${pageTitle}">Thêm Phòng Chiếu</span>
                        </h2>
                        <p class="text-muted mb-0">Tạo mới hoặc chỉnh sửa thông tin phòng chiếu</p>
                    </div>
                    <div>
                        <a th:href="@{/admin/cinema-halls}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay Lại Danh Sách
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <form th:action="@{/admin/cinema-halls/save}" method="post" id="cinemaHallForm">
            <input type="hidden" name="id" th:value="${auditorium != null ? auditorium.id : null}">
            
            <div class="row">
                <!-- Form Information -->
                <div class="col-lg-6">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-info-circle me-2"></i>Thông Tin Cơ Bản
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="theaterId" class="form-label text-light">Rạp Phim <span class="text-danger">*</span></label>
                                <select class="form-select" id="theaterId" name="theaterId" required aria-label="Chọn rạp phim">
                                    <option value="">-- Chọn rạp phim --</option>
                                    <option th:each="theater : ${theaters}" 
                                            th:value="${theater.id}" 
                                            th:selected="${theaterId != null and theaterId == theater.id} or ${auditorium != null and auditorium.theater.id == theater.id}"
                                            th:text="${theater.name}">Tên rạp</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="name" class="form-label text-light">Tên Phòng Chiếu <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       th:value="${auditorium != null ? auditorium.name : ''}"
                                       placeholder="VD: Phòng 1, Phòng VIP A, IMAX Hall..."
                                       aria-describedby="nameHelp">
                                <div id="nameHelp" class="form-text">Nhập tên phòng chiếu dễ nhận biết</div>
                                <div id="nameError" class="text-danger d-none"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="hallType" class="form-label">Loại Phòng</label>
                                <select class="form-select" id="hallType" name="hallType" aria-label="Chọn loại phòng">
                                    <option value="standard">Tiêu chuẩn</option>
                                    <option value="vip">VIP</option>
                                    <option value="imax">IMAX</option>
                                    <option value="4dx">4DX</option>
                                    <option value="gold">Gold Class</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="status" class="form-label">Trạng Thái</label>
                                <select class="form-select" id="status" name="status" aria-label="Chọn trạng thái">
                                    <option value="active">Hoạt động</option>
                                    <option value="maintenance">Bảo trì</option>
                                    <option value="disabled">Tạm ngưng</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Seat Configuration -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-chair me-2"></i>Cấu Hình Ghế Ngồi
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="rows" class="form-label text-light">Số Hàng <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="rows" name="rows" min="1" max="20" 
                                       value="5" required onchange="updateSeatLayout()"
                                       th:readonly="${auditorium != null}">
                                <small class="form-text text-muted" th:if="${auditorium != null}">Không thể thay đổi khi đã có ghế</small>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="seatsPerRow" class="form-label text-light">Ghế/Hàng <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="seatsPerRow" name="seatsPerRow" 
                                       min="1" max="30" value="10" required onchange="updateSeatLayout()"
                                       th:readonly="${auditorium != null}">
                                <small class="form-text text-muted" th:if="${auditorium != null}">Không thể thay đổi khi đã có ghế</small>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="totalSeats" class="form-label text-light">Tổng Ghế</label>
                                <input type="number" class="form-control" id="totalSeats" name="totalSeats" 
                                       readonly th:value="${auditorium != null ? auditorium.totalSeats : 50}">
                            </div>
                            
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Mẹo:</strong> Thay đổi số hàng và ghế per hàng để xem bố trí ghế bên cạnh. 
                                    Bạn có thể tùy chỉnh từng ghế sau khi tạo cấu hình cơ bản.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-section">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Lưu Phòng Chiếu
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveAndAddAnother()">
                                <i class="fas fa-plus me-2"></i>Lưu & Thêm Mới
                            </button>
                            <a th:href="@{/admin/cinema-halls}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Hủy
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Seat Layout Preview -->
                <div class="col-lg-6">
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-eye me-2"></i>Xem Trước Bố Trí Ghế
                        </h5>
                        
                        <div class="seat-layout-designer" id="seatLayoutPreview">
                            <div class="text-muted mb-3">
                                <i class="fas fa-tv fa-2x mb-2"></i>
                                <div>MÀN HÌNH CHIẾU</div>
                            </div>
                            
                            <div class="seat-grid" id="seatGrid">
                                <!-- Seats will be generated here -->
                            </div>
                            
                            <div class="seat-legend">
                                <div class="legend-item">
                                    <div class="legend-color available"></div>
                                    <span>Ghế thường</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color vip"></div>
                                    <span>Ghế VIP</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color unavailable"></div>
                                    <span>Ghế bảo trì</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color disabled"></div>
                                    <span>Không có ghế</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Click vào ghế để thay đổi loại. Bố trí chi tiết có thể chỉnh sửa sau khi lưu.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let seatLayout = [];
        
        // Initialize seat layout on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSeatLayout();
        });
        
        function updateSeatLayout() {
            const rows = parseInt(document.getElementById('rows').value) || 5;
            const seatsPerRow = parseInt(document.getElementById('seatsPerRow').value) || 10;
            const totalSeats = rows * seatsPerRow;
            
            document.getElementById('totalSeats').value = totalSeats;
            
            // Initialize seat layout array
            seatLayout = [];
            for (let r = 0; r < rows; r++) {
                seatLayout[r] = [];
                for (let s = 0; s < seatsPerRow; s++) {
                    seatLayout[r][s] = 'available';
                }
            }
            
            generateSeatGrid();
        }
        
        function generateSeatGrid() {
            const rows = parseInt(document.getElementById('rows').value) || 5;
            const seatsPerRow = parseInt(document.getElementById('seatsPerRow').value) || 10;
            const seatGrid = document.getElementById('seatGrid');
            
            // Set grid columns
            seatGrid.style.gridTemplateColumns = `repeat(${seatsPerRow}, 1fr)`;
            
            // Clear existing seats
            seatGrid.innerHTML = '';
            
            // Generate seats
            for (let r = 0; r < rows; r++) {
                for (let s = 0; s < seatsPerRow; s++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat-item ' + seatLayout[r][s];
                    seat.dataset.row = r;
                    seat.dataset.seat = s;
                    seat.textContent = String.fromCharCode(65 + r) + (s + 1);
                    seat.onclick = () => toggleSeatType(r, s);
                    seatGrid.appendChild(seat);
                }
            }
        }
        
        function toggleSeatType(row, seat) {
            const currentType = seatLayout[row][seat];
            const types = ['available', 'vip', 'unavailable', 'disabled'];
            const currentIndex = types.indexOf(currentType);
            const nextIndex = (currentIndex + 1) % types.length;
            
            seatLayout[row][seat] = types[nextIndex];
            generateSeatGrid();
        }
        
        function saveAndAddAnother() {
            // Set a flag to indicate we want to add another
            const form = document.getElementById('cinemaHallForm');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'addAnother';
            input.value = 'true';
            form.appendChild(input);
            form.submit();
        }
        
        // Form validation
        document.getElementById('cinemaHallForm').addEventListener('submit', function(e) {
            const name = document.getElementById('name').value.trim();
            const theaterId = document.getElementById('theaterId').value;
            const rows = document.getElementById('rows').value;
            const seatsPerRow = document.getElementById('seatsPerRow').value;
            
            if (!name || !theaterId || !rows || !seatsPerRow) {
                e.preventDefault();
                alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                return;
            }
            
            if (parseInt(rows) < 1 || parseInt(seatsPerRow) < 1) {
                e.preventDefault();
                alert('Số hàng và ghế per hàng phải lớn hơn 0!');
                return;
            }
        });
        
        // Auto-generate name based on theater selection
        document.getElementById('theaterId').addEventListener('change', function() {
            const nameInput = document.getElementById('name');
            if (!nameInput.value && this.value) {
                const theaterName = this.options[this.selectedIndex].text;
                if (theaterName !== '-- Chọn rạp phim --') {
                    const hallNumber = Math.floor(Math.random() * 10) + 1;
                    nameInput.value = `Phòng ${hallNumber}`;
                }
            }
        });
        
        // Real-time name validation
        let nameCheckTimeout;
        document.getElementById('name').addEventListener('input', function() {
            clearTimeout(nameCheckTimeout);
            const name = this.value.trim();
            const theaterId = document.getElementById('theaterId').value;
            const id = document.querySelector('input[name="id"]').value;
            
            if (name && theaterId) {
                nameCheckTimeout = setTimeout(() => {
                    checkAuditoriumName(name, theaterId, id);
                }, 500);
            }
        });
        
        function checkAuditoriumName(name, theaterId, id) {
            const params = new URLSearchParams({
                name: name,
                theaterId: theaterId
            });
            
            if (id) {
                params.append('id', id);
            }
            
            fetch(`/admin/cinema-halls/api/check-name?${params}`)
                .then(response => response.json())
                .then(data => {
                    const errorDiv = document.getElementById('nameError');
                    const nameInput = document.getElementById('name');
                    
                    if (data.exists) {
                        errorDiv.textContent = data.message;
                        errorDiv.classList.remove('d-none');
                        nameInput.classList.add('is-invalid');
                    } else {
                        errorDiv.classList.add('d-none');
                        nameInput.classList.remove('is-invalid');
                    }
                })
                .catch(error => {
                    console.error('Error checking name:', error);
                });
        }
    </script>
</body>
</html>
