<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Phim TMDB - CinemaBooking</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Cinema Theme CSS -->
    <link th:href="@{/css/cinema-theme.css}" rel="stylesheet">
</head>
<body class="bg-dark">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" th:href="@{/}">
                <i class="fas fa-film me-2"></i>CinemaBooking Admin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/admin/tmdb}">
                            <i class="fas fa-video me-1"></i>TMDB Movies
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/tmdb/search}">
                            <i class="fas fa-search me-1"></i>Tìm Kiếm TMDB
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span sec:authentication="name">Admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/}">
                                <i class="fas fa-home me-2"></i>Về trang chủ
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" th:href="@{/auth/logout}">
                                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-0">
                                <i class="fas fa-database me-3 text-primary"></i>Quản Lý Phim TMDB
                            </h1>
                            <p class="text-muted mt-2">Tìm kiếm và nhập phim từ The Movie Database</p>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary" onclick="syncLocalMovies()">
                                <i class="fas fa-sync-alt me-2"></i>Đồng bộ phim cục bộ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-search me-2"></i>Tìm Kiếm Phim TMDB
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="tmdbSearchForm" class="row g-3">
                                <div class="col-md-8">
                                    <label for="searchQuery" class="form-label">Tên phim</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-film"></i>
                                        </span>
                                        <input type="text" class="form-control" id="searchQuery" 
                                               placeholder="Nhập tên phim để tìm kiếm..." required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label for="searchYear" class="form-label">Năm (tùy chọn)</label>
                                    <input type="number" class="form-control" id="searchYear" 
                                           placeholder="2024" min="1900" max="2030">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100" id="searchBtn">
                                        <i class="fas fa-search me-2"></i>Tìm kiếm
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Import Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-download me-2"></i>Nhập Nhanh Phim TMDB
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-success w-100" onclick="importPopularMovies()">
                                        <i class="fas fa-star me-2"></i>Nhập Phim Phổ Biến
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-info w-100" onclick="importNowPlayingMovies()">
                                        <i class="fas fa-play me-2"></i>Nhập Phim Đang Chiếu
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="d-none">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list me-2"></i>Kết Quả Tìm Kiếm
                                </h5>
                                <span class="badge bg-primary" id="resultCount">0 phim</span>
                            </div>
                            <div class="card-body">
                                <!-- Loading Spinner -->
                                <div id="loadingSpinner" class="text-center py-5 d-none">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-3 text-muted">Đang tìm kiếm phim...</p>
                                </div>

                                <!-- Search Results -->
                                <div id="searchResults" class="row g-4">
                                    <!-- Results will be inserted here -->
                                </div>

                                <!-- No Results -->
                                <div id="noResults" class="text-center py-5 d-none">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Không tìm thấy phim nào</h5>
                                    <p class="text-muted">Hãy thử với từ khóa khác</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Local Movies Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-database me-2"></i>Phim Trong Cơ Sở Dữ Liệu
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="loadLocalMovies()">
                                <i class="fas fa-refresh me-2"></i>Làm mới
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="localMoviesContainer">
                                <!-- Local movies will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle text-success me-2"></i>Thành Công
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage">Phim đã được thêm thành công!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>Lỗi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">Có lỗi xảy ra!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let searchResults = [];
        let localMovies = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalMovies();
            
            // Setup search form
            document.getElementById('tmdbSearchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                searchTMDBMovies();
            });
        });

        // Search TMDB movies
        async function searchTMDBMovies() {
            const query = document.getElementById('searchQuery').value.trim();
            const year = document.getElementById('searchYear').value;
            
            if (!query && !year) {
                showError('Vui lòng nhập tên phim hoặc năm để tìm kiếm');
                return;
            }

            // Show loading
            showLoading(true);
            document.getElementById('resultsSection').classList.remove('d-none');

            try {
                let url = `/admin/tmdb/api/search?`;
                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (year) params.append('year', year);
                url += params.toString();
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Lỗi khi tìm kiếm phim');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    searchResults = data.results || [];
                    displaySearchResults(searchResults);
                } else {
                    throw new Error(data.error || 'Lỗi không xác định');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showError('Không thể tìm kiếm phim. Vui lòng thử lại.');
            } finally {
                showLoading(false);
            }
        }

        // Display search results
        function displaySearchResults(movies) {
            const container = document.getElementById('searchResults');
            const countElement = document.getElementById('resultCount');
            const noResults = document.getElementById('noResults');
            
            countElement.textContent = `${movies.length} phim`;
            
            if (movies.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            }
            
            noResults.classList.add('d-none');
            
            container.innerHTML = movies.map(movie => createMovieCard(movie)).join('');
        }

        // Create movie card HTML
        function createMovieCard(movie) {
            const posterUrl = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w300${movie.poster_path}` 
                : '/images/no-poster.jpg';
            
            const releaseYear = movie.release_date ? new Date(movie.release_date).getFullYear() : 'N/A';
            const rating = movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A';
            
            return `
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card movie-card h-100">
                        <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">${movie.title}</h6>
                            <small class="text-muted mb-2">${movie.original_title !== movie.title ? movie.original_title : ''}</small>
                            <div class="movie-info mb-3 flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small><i class="fas fa-calendar me-1"></i>${releaseYear}</small>
                                    <small class="rating"><i class="fas fa-star me-1"></i>${rating}</small>
                                </div>
                                <small class="text-muted">${movie.overview ? movie.overview.substring(0, 100) + '...' : 'Không có mô tả'}</small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="importMovie(${movie.id})" 
                                    id="import-btn-${movie.id}">
                                <i class="fas fa-download me-2"></i>Nhập phim
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Import movie
        async function importMovie(tmdbId) {
            const button = document.getElementById(`import-btn-${tmdbId}`);
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang nhập...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/admin/tmdb/import/${tmdbId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Lỗi khi nhập phim');
                }
                
                const result = await response.json();
                showSuccess('Phim đã được nhập thành công!');
                
                // Update button state
                button.innerHTML = '<i class="fas fa-check me-2"></i>Đã nhập';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                // Reload local movies
                setTimeout(() => {
                    loadLocalMovies();
                }, 1000);
                
            } catch (error) {
                console.error('Import error:', error);
                showError(error.message);
                
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Load local movies
        async function loadLocalMovies() {
            try {
                const response = await fetch('/api/movies');
                if (!response.ok) {
                    throw new Error('Lỗi khi tải phim cục bộ');
                }
                
                localMovies = await response.json();
                displayLocalMovies(localMovies);
                
            } catch (error) {
                console.error('Load local movies error:', error);
                document.getElementById('localMoviesContainer').innerHTML = 
                    '<div class="text-center text-muted">Không thể tải danh sách phim</div>';
            }
        }

        // Display local movies
        function displayLocalMovies(movies) {
            const container = document.getElementById('localMoviesContainer');
            
            if (movies.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Chưa có phim nào trong cơ sở dữ liệu</div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Poster</th>
                                <th>Tên phim</th>
                                <th>Thể loại</th>
                                <th>Năm</th>
                                <th>TMDB ID</th>
                                <th>Đánh giá</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${movies.map(movie => `
                                <tr>
                                    <td>
                                        <img src="${movie.imageUrl || '/images/no-poster.jpg'}" 
                                             alt="${movie.title}" style="width: 50px; height: 75px; object-fit: cover;">
                                    </td>
                                    <td>
                                        <strong>${movie.title}</strong>
                                        ${movie.originalTitle && movie.originalTitle !== movie.title ? 
                                            `<br><small class="text-muted">${movie.originalTitle}</small>` : ''}
                                    </td>
                                    <td><span class="badge bg-secondary">${movie.genre || 'N/A'}</span></td>
                                    <td>${movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : 'N/A'}</td>
                                    <td>${movie.tmdbId ? `<span class="badge bg-info">${movie.tmdbId}</span>` : '<span class="text-muted">-</span>'}</td>
                                    <td>${movie.voteAverage ? `<span class="rating">${movie.voteAverage.toFixed(1)} <i class="fas fa-star"></i></span>` : 'N/A'}</td>
                                    <td>
                                        <a href="/admin/movies/${movie.id}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        // Utility functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const results = document.getElementById('searchResults');
            const noResults = document.getElementById('noResults');
            
            if (show) {
                spinner.classList.remove('d-none');
                results.innerHTML = '';
                noResults.classList.add('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            new bootstrap.Modal(document.getElementById('successModal')).show();
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        }

        function syncLocalMovies() {
            loadLocalMovies();
            showSuccess('Danh sách phim đã được đồng bộ!');
        }

        // Quick import functions
        async function importPopularMovies() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang nhập...';
            button.disabled = true;
            
            try {
                const response = await fetch('/admin/tmdb/import-popular', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    await loadLocalMovies(); // Refresh the local movies list
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Lỗi khi nhập phim phổ biến: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function importNowPlayingMovies() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang nhập...';
            button.disabled = true;
            
            try {
                const response = await fetch('/admin/tmdb/import-now-playing', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    await loadLocalMovies(); // Refresh the local movies list
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Lỗi khi nhập phim đang chiếu: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
