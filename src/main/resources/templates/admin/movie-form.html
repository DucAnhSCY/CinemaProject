<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Quản Lý Phim - Cinema Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
    <style>
        .poster-preview-container {
            min-height: 300px;
        }
        .poster-preview {
            max-width: 100%;
            max-height: 280px;
            object-fit: contain;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/admin}">
                <i class="fas fa-film me-2"></i>Cinema Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/admin/movies}">
                    <i class="fas fa-arrow-left me-1"></i>Quay Về Danh Sách
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Alert Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>
        </div>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-video me-3"></i>
                    <span th:if="${movie.id == null}">Thêm Phim Mới</span>
                    <span th:if="${movie.id != null}">Chỉnh Sửa Phim</span>
                </h2>
            </div>
        </div>

        <!-- Movie Form -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Thông Tin Phim</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="${movie.id != null ? '/admin/movies/' + movie.id + '/edit' : '/admin/movies/new'}" 
                              method="post" id="movieForm" th:object="${movie}" enctype="multipart/form-data">
                            
                            <!-- CSRF Token for multipart forms -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <div class="row">
                                <!-- Basic Information -->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="title" class="form-label">
                                                <i class="fas fa-text-width me-1"></i>Tên Phim <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="title" th:field="*{title}" 
                                                   required maxlength="200" placeholder="Nhập tên phim">
                                            <div class="invalid-feedback">
                                                Vui lòng nhập tên phim.
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="originalTitle" class="form-label">
                                                <i class="fas fa-language me-1"></i>Tên Gốc
                                            </label>
                                            <input type="text" class="form-control" id="originalTitle" th:field="*{originalTitle}" 
                                                   maxlength="200" placeholder="Tên phim gốc (nếu có)">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="genre" class="form-label">
                                                <i class="fas fa-tags me-1"></i>Thể Loại <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="genre" th:field="*{genre}" 
                                                   required maxlength="100" placeholder="Ví dụ: Hành động, Phiêu lưu">
                                            <div class="invalid-feedback">
                                                Vui lòng nhập thể loại phim.
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <label for="durationMin" class="form-label">
                                                <i class="fas fa-clock me-1"></i>Thời Lượng (phút)
                                            </label>
                                            <input type="number" class="form-control" id="durationMin" th:field="*{durationMin}" 
                                                   min="1" max="500" placeholder="120">
                                            <div class="invalid-feedback">
                                                Thời lượng phải từ 1 đến 500 phút.
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <label for="releaseDate" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Ngày Công Chiếu
                                            </label>
                                            <input type="date" class="form-control" id="releaseDate" th:field="*{releaseDate}">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="director" class="form-label">
                                                <i class="fas fa-user-tie me-1"></i>Đạo Diễn
                                            </label>
                                            <input type="text" class="form-control" id="director" th:field="*{director}" 
                                                   maxlength="100" placeholder="Tên đạo diễn">
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="cast" class="form-label">
                                                <i class="fas fa-users me-1"></i>Diễn Viên
                                            </label>
                                            <input type="text" class="form-control" id="cast" th:field="*{cast}" 
                                                   maxlength="500" placeholder="Tên các diễn viên, cách nhau bởi dấu phẩy">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="language" class="form-label">
                                                <i class="fas fa-globe me-1"></i>Ngôn Ngữ
                                            </label>
                                            <input type="text" class="form-control" id="language" th:field="*{language}" 
                                                   maxlength="50" placeholder="Tiếng Việt, Tiếng Anh">
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="country" class="form-label">
                                                <i class="fas fa-flag me-1"></i>Quốc Gia
                                            </label>
                                            <input type="text" class="form-control" id="country" th:field="*{country}" 
                                                   maxlength="100" placeholder="Việt Nam, Mỹ">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="overview" class="form-label">
                                            <i class="fas fa-align-left me-1"></i>Tóm Tắt Nội Dung
                                        </label>
                                        <textarea class="form-control" id="overview" th:field="*{overview}" 
                                                  rows="4" maxlength="1000" placeholder="Mô tả nội dung phim..."></textarea>
                                        <small class="form-text text-muted">Tối đa 1000 ký tự.</small>
                                    </div>
                                </div>

                                <!-- Poster and Rating -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="imageUrl" class="form-label">
                                            <i class="fas fa-image me-1"></i>URL Poster
                                        </label>
                                        <input type="url" class="form-control" id="imageUrl" th:field="*{imageUrl}" 
                                               placeholder="https://example.com/poster.jpg">
                                        <small class="form-text text-muted">Liên kết đến hình ảnh poster phim.</small>
                                    </div>

                                    <!-- Poster Preview -->
                                    <div class="mb-3">
                                        <label class="form-label">Xem Trước Poster</label>
                                        <div class="border rounded p-3 text-center poster-preview-container">
                                            <img id="posterPreview" th:src="${movie.imageUrl}" 
                                                 class="poster-preview" alt="Poster Preview" title="Poster Preview">
                                            <div id="noPosterText" class="text-muted">
                                                <i class="fas fa-image fa-3x mb-3"></i>
                                                <p>Chưa có poster</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <label for="voteAverage" class="form-label">
                                                <i class="fas fa-star me-1"></i>Điểm Đánh Giá
                                            </label>
                                            <input type="number" class="form-control" id="voteAverage" th:field="*{voteAverage}" 
                                                   min="0" max="10" step="0.1" placeholder="8.5">
                                            <small class="form-text text-muted">Từ 0.0 đến 10.0</small>
                                        </div>

                                        <div class="col-6 mb-3">
                                            <label for="voteCount" class="form-label">
                                                <i class="fas fa-poll me-1"></i>Số Lượt Đánh Giá
                                            </label>
                                            <input type="number" class="form-control" id="voteCount" th:field="*{voteCount}" 
                                                   min="0" placeholder="1523">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="tmdbId" class="form-label">
                                            <i class="fas fa-database me-1"></i>TMDB ID
                                        </label>
                                        <input type="number" class="form-control" id="tmdbId" th:field="*{tmdbId}" 
                                               placeholder="12345">
                                        <small class="form-text text-muted">ID từ The Movie Database (nếu có).</small>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between">
                                <a th:href="@{/admin/movies}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Hủy
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>
                                    <span th:if="${movie.id == null}">Thêm Phim</span>
                                    <span th:if="${movie.id != null}">Cập Nhật</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                const form = document.getElementById('movieForm');
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            }, false);
        })();

        // Poster preview
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('posterPreview');
            const noText = document.getElementById('noPosterText');
            
            if (url && url.startsWith('http')) {
                preview.src = url;
                preview.style.display = 'block';
                noText.style.display = 'none';
                
                preview.onerror = function() {
                    this.style.display = 'none';
                    noText.style.display = 'block';
                };
            } else {
                preview.style.display = 'none';
                noText.style.display = 'block';
            }
        });

        // Initialize poster preview on page load
        window.addEventListener('load', function() {
            const imageUrl = document.getElementById('imageUrl').value;
            if (imageUrl) {
                document.getElementById('imageUrl').dispatchEvent(new Event('input'));
            }
        });

        // Character counter for overview
        const overviewField = document.getElementById('overview');
        const maxLength = 1000;
        
        overviewField.addEventListener('input', function() {
            const remaining = maxLength - this.value.length;
            const counter = this.nextElementSibling;
            counter.textContent = `${remaining} ký tự còn lại`;
            
            if (remaining < 100) {
                counter.classList.add('text-warning');
            } else {
                counter.classList.remove('text-warning');
            }
        });
    </script>
</body>
</html>
