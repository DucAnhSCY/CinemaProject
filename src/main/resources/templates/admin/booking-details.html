<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đặt Vé - Cinema Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/admin}">
                <i class="fas fa-film me-2"></i>Cinema Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/admin/bookings}">
                    <i class="fas fa-arrow-left me-1"></i>Quay Về Danh Sách
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-ticket-alt me-3"></i>Chi Tiết Đặt Vé</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                                <li class="breadcrumb-item"><a th:href="@{/admin/bookings}">Quản Lý Vé</a></li>
                                <li class="breadcrumb-item active">Chi Tiết Vé #<span th:text="${booking.id}">123</span></li>
                            </ol>
                        </nav>
                    </div>
                    <div class="btn-group">
                        <!-- Status Update Buttons -->
                        <button th:if="${booking.bookingStatus != null and booking.bookingStatus.name() == 'RESERVED'}" 
                                type="button" class="btn btn-success" 
                                onclick="confirmBooking()">
                            <i class="fas fa-check me-2"></i>Xác Nhận
                        </button>
                        <button th:if="${booking.bookingStatus != null and booking.bookingStatus.name() == 'CONFIRMED'}" 
                                type="button" class="btn btn-warning" 
                                onclick="cancelBooking()">
                            <i class="fas fa-times me-2"></i>Hủy Vé
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="printTicket()">
                            <i class="fas fa-print me-2"></i>In Vé
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="sendNotification()">
                            <i class="fas fa-envelope me-2"></i>Gửi Thông Báo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Status Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-0">Mã Đặt Vé: #<span th:text="${booking.id}">123</span></h4>
                                <p class="text-muted mb-0">
                                    Đặt lúc: <span th:text="${#temporals.format(booking.bookingTime, 'dd/MM/yyyy HH:mm')}">25/07/2024 14:30</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span th:if="${booking.bookingStatus != null}" 
                                      th:switch="${booking.bookingStatus.name()}" 
                                      class="badge fs-6 px-3 py-2">
                                    <span th:case="'RESERVED'" class="badge bg-warning">Chờ xác nhận</span>
                                    <span th:case="'CONFIRMED'" class="badge bg-success">Đã xác nhận</span>
                                    <span th:case="'CANCELLED'" class="badge bg-danger">Đã hủy</span>
                                    <span th:case="'EXPIRED'" class="badge bg-info">Hết hạn</span>
                                    <span th:case="*" class="badge bg-secondary">Không xác định</span>
                                </span>
                                <span th:if="${booking.bookingStatus == null}" 
                                      class="badge bg-secondary fs-6 px-3 py-2">
                                    Chưa xác định
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Customer Information -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Thông Tin Khách Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${booking.user}">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-placeholder bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0" th:text="${booking.user.fullName ?: booking.user.username}">Tên khách hàng</h6>
                                    <small class="text-muted">@<span th:text="${booking.user.username}">username</span></small>
                                </div>
                            </div>
                            <div class="contact-info">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    <span th:text="${booking.user.email}">email@example.com</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar text-muted me-2"></i>
                                    <span>Tham gia: <span th:text="${booking.user.createdAt != null ? #temporals.format(booking.user.createdAt, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</span></span>
                                </div>
                            </div>
                        </div>
                        <div th:if="${booking.user == null}" class="text-center text-muted">
                            <i class="fas fa-user-slash fa-2x mb-2"></i>
                            <p>Khách vãng lai</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movie & Screening Information -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-film me-2"></i>Thông Tin Suất Chiếu</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${booking.screening != null}">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="movie-poster-container mb-3">
                                        <img th:src="${booking.screening.movie != null ? (booking.screening.movie.posterUrl ?: '/images/default-movie-poster.jpg') : '/images/default-movie-poster.jpg'}" 
                                             th:alt="${booking.screening.movie != null ? booking.screening.movie.title : 'Movie'}"
                                             class="img-fluid rounded shadow-sm" 
                                             style="max-height: 200px; width: 100%; object-fit: cover;">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <h4 th:text="${booking.screening.movie != null ? booking.screening.movie.title : 'N/A'}" class="mb-2">Tên phim</h4>
                                    <div class="movie-details mb-3" th:if="${booking.screening.movie != null}">
                                        <p class="mb-1">
                                            <strong>Thể loại:</strong> 
                                            <span th:text="${booking.screening.movie.genre ?: 'N/A'}">Hành động</span>
                                        </p>
                                        <p class="mb-1">
                                            <strong>Thời lượng:</strong> 
                                            <span th:text="${booking.screening.movie.durationMin != null ? (booking.screening.movie.durationMin + ' phút') : 'N/A'}">120 phút</span>
                                        </p>
                                        <p class="mb-1">
                                            <strong>Đánh giá:</strong> 
                                            <span th:text="${booking.screening.movie.rating ?: 'Chưa có'}">8.5/10</span>
                                        </p>
                                    </div>
                                    
                                    <div class="screening-details">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="detail-item p-3 bg-light rounded mb-2">
                                                    <i class="fas fa-building text-primary me-2"></i>
                                                    <strong>Rạp:</strong><br>
                                                    <span th:text="${booking.screening.auditorium != null and booking.screening.auditorium.theater != null ? booking.screening.auditorium.theater.name : 'N/A'}">Tên rạp</span>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="detail-item p-3 bg-light rounded mb-2">
                                                    <i class="fas fa-door-open text-info me-2"></i>
                                                    <strong>Phòng:</strong><br>
                                                    <span th:text="${booking.screening.auditorium != null ? booking.screening.auditorium.name : 'N/A'}">Phòng 1</span>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="detail-item p-3 bg-light rounded mb-2">
                                                    <i class="fas fa-clock text-warning me-2"></i>
                                                    <strong>Giờ chiếu:</strong><br>
                                                    <span th:text="${booking.screening.startTime != null ? #temporals.format(booking.screening.startTime, 'HH:mm') : 'N/A'}">19:30</span>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="detail-item p-3 bg-light rounded mb-2">
                                                    <i class="fas fa-calendar text-success me-2"></i>
                                                    <strong>Ngày chiếu:</strong><br>
                                                    <span th:text="${booking.screening.startTime != null ? #temporals.format(booking.screening.startTime, 'dd/MM/yyyy') : 'N/A'}">25/07/2024</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seats & Payment Information -->
        <div class="row">
            <!-- Seat Information -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-couch me-2"></i>Thông Tin Ghế</h5>
                    </div>
                    <div class="card-body">
                        <!-- Debug info (temporary) -->
                        <div th:if="${booking.bookedSeats != null}" class="alert alert-info mb-3">
                            Debug: BookedSeats size = <span th:text="${#lists.size(booking.bookedSeats)}">0</span>
                        </div>
                        <div th:if="${booking.bookedSeats == null}" class="alert alert-warning mb-3">
                            Debug: BookedSeats is null
                        </div>
                        
                        <div th:if="${booking.bookedSeats != null and !#lists.isEmpty(booking.bookedSeats)}" class="seats-grid">
                            <div class="row">
                                <div th:each="bookedSeat : ${booking.bookedSeats}" class="col-auto mb-2">
                                    <div class="seat-item p-2 rounded text-center" 
                                         th:classappend="${bookedSeat.seat != null and bookedSeat.seat.type != null and bookedSeat.seat.type.name() == 'VIP'} ? 'bg-warning text-dark' : (${bookedSeat.seat != null and bookedSeat.seat.type != null and bookedSeat.seat.type.name() == 'COUPLE'} ? 'bg-danger text-white' : 'bg-primary text-white')">
                                        <strong th:text="${bookedSeat.seat != null ? bookedSeat.seat.name : 'N/A'}">A1</strong>
                                        <br>
                                        <small th:text="${bookedSeat.seat != null and bookedSeat.seat.type != null ? bookedSeat.seat.type.name() : 'Standard'}">Standard</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="mb-1"><strong>Tổng số ghế:</strong> <span th:text="${#lists.size(booking.bookedSeats)}">2</span> ghế</p>
                                <div class="seat-types-summary">
                                    <small class="text-muted">
                                        <i class="fas fa-circle text-primary me-1"></i> Standard
                                        <i class="fas fa-circle text-warning me-1 ms-2"></i> VIP
                                        <i class="fas fa-circle text-danger me-1 ms-2"></i> Couple
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div th:if="${booking.bookedSeats == null || #lists.isEmpty(booking.bookedSeats)}" class="text-center text-muted py-3">
                            <i class="fas fa-couch fa-2x mb-2"></i>
                            <p>Không có thông tin ghế</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Thông Tin Thanh Toán</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-summary">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Giá vé cơ bản:</span>
                                <span th:text="${#numbers.formatDecimal(booking.screening.ticketPrice / 1000, 0, 'COMMA', 3, 'POINT') + ' VNĐ'}">100 VNĐ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Số lượng ghế:</span>
                                <span th:text="${#lists.size(booking.bookedSeats ?: {}) + ' ghế'}">2 ghế</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Tổng cộng:</strong>
                                <strong class="text-success" th:text="${#numbers.formatDecimal(booking.totalAmount / 1000, 0, 'COMMA', 3, 'POINT') + ' VNĐ'}">200 VNĐ</strong>
                            </div>
                            
                            <div class="payment-status mt-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Phương thức thanh toán:</strong> 
                                    <span th:text="${booking.paymentMethod ?: 'Chưa xác định'}">Chuyển khoản</span>
                                </div>
                                
                                <div th:if="${booking.paymentStatus}" class="alert" 
                                     th:classappend="${booking.paymentStatus == 'PAID'} ? 'alert-success' : 'alert-warning'">
                                    <i th:class="${booking.paymentStatus == 'PAID'} ? 'fas fa-check-circle me-2' : 'fas fa-clock me-2'"></i>
                                    <strong>Trạng thái thanh toán:</strong> 
                                    <span th:switch="${booking.paymentStatus}">
                                        <span th:case="'PAID'">Đã thanh toán</span>
                                        <span th:case="'PENDING'">Chờ thanh toán</span>
                                        <span th:case="'FAILED'">Thanh toán thất bại</span>
                                        <span th:case="*">Chưa xác định</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action History -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Lịch Sử Thao Tác</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <h6>Đặt vé</h6>
                                    <p class="text-muted mb-0" th:text="${#temporals.format(booking.bookingTime, 'dd/MM/yyyy HH:mm')}">25/07/2024 14:30</p>
                                    <small class="text-muted">Khách hàng thực hiện đặt vé</small>
                                </div>
                            </div>
                            
                            <div th:if="${booking.bookingStatus.name() != 'RESERVED'}" class="timeline-item">
                                <div class="timeline-marker" 
                                     th:classappend="${booking.bookingStatus.name() == 'CONFIRMED'} ? 'bg-success' : (${booking.bookingStatus.name() == 'CANCELLED'} ? 'bg-danger' : 'bg-warning')"></div>
                                <div class="timeline-content">
                                    <h6 th:switch="${booking.bookingStatus.name()}">
                                        <span th:case="'CONFIRMED'">Xác nhận đặt vé</span>
                                        <span th:case="'CANCELLED'">Hủy đặt vé</span>
                                        <span th:case="*">Cập nhật trạng thái</span>
                                    </h6>
                                    <p class="text-muted mb-0" th:text="${#temporals.format(booking.updatedAt ?: booking.bookingTime, 'dd/MM/yyyy HH:mm')}">25/07/2024 14:35</p>
                                    <small class="text-muted">Quản trị viên thực hiện</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const bookingId = /*[[${booking.id}]]*/ 0;
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // Confirm booking
        async function confirmBooking() {
            if (!confirm('Bạn có chắc chắn muốn xác nhận đặt vé này?')) {
                return;
            }

            try {
                const response = await fetch(`/admin/bookings/${bookingId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        [header]: token
                    }
                });

                const result = await response.text();
                
                if (result === 'success') {
                    showAlert('Đã xác nhận đặt vé thành công!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('Lỗi: ' + result.replace('error: ', ''), 'danger');
                }
            } catch (error) {
                showAlert('Lỗi khi xác nhận đặt vé: ' + error.message, 'danger');
            }
        }

        // Cancel booking
        async function cancelBooking() {
            if (!confirm('Bạn có chắc chắn muốn hủy đặt vé này? Thao tác này không thể hoàn tác.')) {
                return;
            }

            try {
                const response = await fetch(`/admin/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        [header]: token
                    }
                });

                const result = await response.text();
                
                if (result === 'success') {
                    showAlert('Đã hủy đặt vé thành công!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('Lỗi: ' + result.replace('error: ', ''), 'danger');
                }
            } catch (error) {
                showAlert('Lỗi khi hủy đặt vé: ' + error.message, 'danger');
            }
        }

        // Print ticket
        function printTicket() {
            window.open('/booking/confirmation/' + bookingId, '_blank');
        }

        // Send notification
        function sendNotification() {
            // TODO: Implement notification sending
            showAlert('Chức năng gửi thông báo sẽ được phát triển trong phiên bản tiếp theo!', 'info');
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
    
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -22px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .seat-item {
            min-width: 60px;
            transition: transform 0.2s;
        }
        
        .seat-item:hover {
            transform: scale(1.05);
        }
        
        .movie-poster-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .detail-item {
            transition: transform 0.2s;
        }
        
        .detail-item:hover {
            transform: translateY(-2px);
        }
        
        .avatar-placeholder {
            font-size: 1.2rem;
        }
    </style>
</body>
</html>
